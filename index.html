<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biomarker Discovery Agent Evaluation</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
            color: #212529;
            padding-bottom: 50px;
        }
        .container {
            max-width: 900px;
        }
        .step-container {
            display: none;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            animation: fadeIn 0.5s ease-in-out;
        }
        .step-container.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header-title {
            font-weight: 700;
            color: #0d6efd;
            margin-bottom: 10px;
        }
        .pdf-viewer {
            width: 100%;
            height: 750px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            font-weight: 700;
            color: #0d6efd;
            border-top: 3px solid #0d6efd;
        }
        .progress {
            height: 8px;
            margin-bottom: 30px;
            background-color: #e9ecef;
            border-radius: 10px;
        }
        .task-row {
            border-bottom: 1px solid #f1f3f5;
            padding: 15px 0;
        }
        .task-row:last-child {
            border-bottom: none;
        }
        .required-star {
            color: red;
        }
    </style>
</head>
<body>

    <div class="container py-5">
        
        <!-- Progress Bar -->
        <div class="mb-4">
            <h5 id="step-indicator" class="text-muted text-center mb-3">Step 1 of 4</h5>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>

        <form id="mainForm" onsubmit="return false;">
            
            <!-- STEP 1: Participant Info -->
            <div class="step-container active" id="step1">
                <h2 class="header-title">Participant Information</h2>
                <p class="text-muted mb-4">Please provide your background information to begin the evaluation.</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Name <span class="required-star">*</span></label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Address <span class="required-star">*</span></label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Affiliation / Institution <span class="required-star">*</span></label>
                        <input type="text" class="form-control" id="userAffiliation" placeholder="e.g. University A, Company B" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Years of Experience in Bioinformatics/DS <span class="required-star">*</span></label>
                        <input type="number" class="form-control" id="userExp" placeholder="e.g. 5" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Primary Expertise <span class="required-star">*</span></label>
                        <select class="form-select" id="userExpertise" required>
                            <option value="" selected disabled>Select...</option>
                            <option value="Bioinformatics">Bioinformatics (Genomics/Transcriptomics)</option>
                            <option value="Clinical Research">Clinical Research / Medicine</option>
                            <option value="Computer Science">Computer Science / AI / NLP</option>
                            <option value="Biology">Molecular Biology</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-primary px-4" id="btnStep1">Next &rarr;</button>
                </div>
            </div>

            <!-- STEP 2: Introduction & Guidelines -->
            <div class="step-container" id="step2">
                <h2 class="header-title">About CoDaS & Guidelines</h2>
                
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h4 class="card-title text-primary fw-bold">What is CoDaS?</h4>
                        <p class="card-text">
                            <strong>CoDaS (Context-aware Data Science Assistant)</strong> is an automated AI agent designed to perform end-to-end biomarker discovery. 
                            Unlike traditional scripts, CoDaS autonomously formulates hypotheses, searches for datasets, writes code for analysis, and interprets biological results.
                        </p>
                        <p class="card-text mb-0">
                            The goal of this research is to evaluate whether CoDaS can generate research outputs comparable to human experts or existing semi-automated tools.
                        </p>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h5 class="alert-heading fw-bold">Evaluation Guidelines</h5>
                    <ul class="mb-0">
                        <li>You will be presented with <strong>3 PDF outputs (Model A, B, C)</strong>.</li>
                        <li>These outputs are <strong>blinded</strong> (you will not know which one is CoDaS).</li>
                        <li>Please review the PDFs based on:
                            <ul>
                                <li><strong>Logical Flow:</strong> Is the analysis process reasonable?</li>
                                <li><strong>Code/Method Quality:</strong> Is the methodology sound?</li>
                                <li><strong>Insight:</strong> Are the biological interpretations valid?</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" id="btnPrev2">&larr; Back</button>
                    <button type="button" class="btn btn-primary px-4" id="btnStep2">Start Evaluation &rarr;</button>
                </div>
            </div>

            <!-- STEP 3: Blinded Evaluation -->
            <div class="step-container" id="step3">
                <h2 class="header-title">Blinded Output Comparison</h2>
                <p class="text-muted">Please review the three outputs below and rank them.</p>

                <!-- PDF Tabs -->
                <ul class="nav nav-tabs mb-3" id="pdfTabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="tab-a" data-bs-toggle="tab" data-bs-target="#modelA" type="button">Model A</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-b" data-bs-toggle="tab" data-bs-target="#modelB" type="button">Model B</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="tab-c" data-bs-toggle="tab" data-bs-target="#modelC" type="button">Model C</button>
                    </li>
                </ul>

                <div class="tab-content mb-4">
                    <div class="tab-pane fade show active" id="modelA">
                        <iframe src="./pdfs/codas.pdf" class="pdf-viewer"></iframe>
                    </div>
                    <div class="tab-pane fade" id="modelB">
                        <iframe src="./pdfs/biomni.pdf" class="pdf-viewer"></iframe>
                    </div>
                    <div class="tab-pane fade" id="modelC">
                        <iframe src="./pdfs/colab_dsa.pdf" class="pdf-viewer"></iframe>
                    </div>
                </div>

                <hr>

                <h4 class="mb-3">Preference Ranking</h4>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-success">1st Place (Best)</label>
                        <select class="form-select ranking-select" id="rank1" required>
                            <option value="" selected disabled>Select Model...</option>
                            <option value="Model A">Model A</option>
                            <option value="Model B">Model B</option>
                            <option value="Model C">Model C</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-secondary">2nd Place</label>
                        <select class="form-select ranking-select" id="rank2" required>
                            <option value="" selected disabled>Select Model...</option>
                            <option value="Model A">Model A</option>
                            <option value="Model B">Model B</option>
                            <option value="Model C">Model C</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold text-danger">3rd Place (Worst)</label>
                        <select class="form-select ranking-select" id="rank3" required>
                            <option value="" selected disabled>Select Model...</option>
                            <option value="Model A">Model A</option>
                            <option value="Model B">Model B</option>
                            <option value="Model C">Model C</option>
                        </select>
                    </div>
                </div>
                <div id="rank-error" class="text-danger mt-2" style="display:none; font-size:0.9rem;">
                    * You cannot select the same model twice. Please assign unique ranks.
                </div>

                <div class="d-flex justify-content-between mt-5">
                    <button type="button" class="btn btn-outline-secondary" id="btnPrev3">&larr; Back</button>
                    <button type="button" class="btn btn-primary px-4" id="btnStep3">Next &rarr;</button>
                </div>
            </div>

            <!-- STEP 4: Time Estimation -->
            <div class="step-container" id="step4">
                <h2 class="header-title">Time Estimation</h2>
                <p class="text-muted">
                    If you were to perform this biomarker discovery task <strong>manually</strong> (without automated agents), 
                    how long would each step take?
                </p>

                <div class="mt-4">
                    <!-- Subtask 1 -->
                    <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">1. Literature Review & Gene Selection</label>
                            <div class="form-text">Searching papers, identifying target biomarkers/genes.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time1" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit1">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subtask 2 -->
                    <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">2. Data Acquisition & Cleaning</label>
                            <div class="form-text">Downloading from GEO/TCGA, mapping probes, normalization.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time2" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit2">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subtask 3 -->
                    <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">3. Differential Expression Analysis (DEA)</label>
                            <div class="form-text">Running DESeq2/Limma, statistical testing.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time3" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit3">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subtask 4 -->
                    <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">4. Feature Selection & ML Modeling</label>
                            <div class="form-text">Dimensionality reduction, training classifiers, tuning hyperparams.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time4" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit4">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                    <!-- Subtask 5 -->
                    <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">5. Biological Interpretation (GO/KEGG)</label>
                            <div class="form-text">Pathway enrichment analysis, functional annotation.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time5" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit5">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>

                     <!-- Subtask 6 -->
                     <div class="task-row row align-items-center">
                        <div class="col-md-6">
                            <label class="fw-bold">6. Report Writing & Documentation</label>
                            <div class="form-text">Summarizing findings, creating figures, writing the manuscript.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="number" class="form-control" id="time6" placeholder="Value">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="unit6">
                                <option value="Hours">Hours</option>
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-5">
                    <button type="button" class="btn btn-outline-secondary" id="btnPrev4">&larr; Back</button>
                    <button type="button" class="btn btn-success btn-lg px-5" id="submitBtn">Submit Annotation</button>
                </div>
            </div>

        </form>
    </div>

    <!-- Bootstrap Bundle JS (for Tabs) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Logic (Realtime Database) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "__FIREBASE_API__",
            authDomain: "ivory-plane-406700.firebaseapp.com",
            databaseURL: "https://ivory-plane-406700-default-rtdb.firebaseio.com",
            projectId: "ivory-plane-406700",
            storageBucket: "ivory-plane-406700.firebasestorage.app",
            messagingSenderId: "360125182471",
            appId: "1:360125182471:web:a50fde959d1b09936530a2",
            measurementId: "G-7BHD9KPBY4"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // --- NAVIGATION STATE ---
        let currentStep = 1;
        const totalSteps = 4;

        function updateUI() {
            for (let i = 1; i <= totalSteps; i++) {
                const el = document.getElementById(`step${i}`);
                if (el) el.classList.remove('active');
            }
            const currentEl = document.getElementById(`step${currentStep}`);
            if (currentEl) currentEl.classList.add('active');
            
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('step-indicator').innerText = `Step ${currentStep} of ${totalSteps}`;
            
            window.scrollTo(0, 0);
        }

        function validateStep(step) {
            if (step === 1) {
                const name = document.getElementById('userName').value;
                const email = document.getElementById('userEmail').value;
                const affil = document.getElementById('userAffiliation').value;
                const exp = document.getElementById('userExp').value;
                const expert = document.getElementById('userExpertise').value;
                if (!name || !email || !affil || !exp || !expert) {
                    alert("Please fill in all required fields.");
                    return false;
                }
            }
            if (step === 3) {
                const r1 = document.getElementById('rank1').value;
                const r2 = document.getElementById('rank2').value;
                const r3 = document.getElementById('rank3').value;
                if (!r1 || !r2 || !r3) {
                    alert("Please complete the ranking for all positions.");
                    return false;
                }
                if (r1 === r2 || r1 === r3 || r2 === r3) {
                    document.getElementById('rank-error').style.display = 'block';
                    alert("Duplicate rankings detected. Please assign a unique model to each rank.");
                    return false;
                }
                document.getElementById('rank-error').style.display = 'none';
            }
            return true;
        }

        function nextStep(step) {
            if (validateStep(step)) {
                if (currentStep < totalSteps) {
                    currentStep++;
                    updateUI();
                }
            }
        }

        function prevStep(step) {
            if (currentStep > 1) {
                currentStep--;
                updateUI();
            }
        }

        async function submitData() {
            console.log("submitData called");

            const t1 = document.getElementById('time1').value;
            if (!t1) {
                if (!confirm("You haven't filled out all time estimations. Submit anyway?")) return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "Saving...";

            const modelMapping = {
                "Model A": "CoDaS",
                "Model B": "Biomni",
                "Model C": "Colab_DSA"
            };

            const data = {
                participant: {
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    affiliation: document.getElementById('userAffiliation').value,
                    experience: document.getElementById('userExp').value,
                    expertise: document.getElementById('userExpertise').value,
                },
                rankings: {
                    rank1_raw: document.getElementById('rank1').value,
                    rank1_mapped: modelMapping[document.getElementById('rank1').value],
                    rank2_raw: document.getElementById('rank2').value,
                    rank2_mapped: modelMapping[document.getElementById('rank2').value],
                    rank3_raw: document.getElementById('rank3').value,
                    rank3_mapped: modelMapping[document.getElementById('rank3').value],
                },
                time_estimation: {
                    step1_lit_review: { val: document.getElementById('time1').value, unit: document.getElementById('unit1').value },
                    step2_data_prep: { val: document.getElementById('time2').value, unit: document.getElementById('unit2').value },
                    step3_dea: { val: document.getElementById('time3').value, unit: document.getElementById('unit3').value },
                    step4_ml: { val: document.getElementById('time4').value, unit: document.getElementById('unit4').value },
                    step5_interpretation: { val: document.getElementById('time5').value, unit: document.getElementById('unit5').value },
                    step6_reporting: { val: document.getElementById('time6').value, unit: document.getElementById('unit6').value },
                },
                timestamp: new Date().toISOString()
            };

            try {
                console.log("Sending to Realtime DB...", data);
                const newRef = push(ref(db, "evaluations"));
                await set(newRef, data);
                console.log("Realtime DB write success");

                alert("Thank you! Your evaluation has been submitted successfully.");
                // 원하는 홈 경로로 변경 (예: "./index.html" 또는 "/")
                window.location.href = "./index.html";
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Submission failed. Check console for details.");
                btn.disabled = false;
                btn.innerText = "Submit Annotation";
            }
        }

        // Attach event listeners
        document.getElementById('btnStep1').addEventListener('click', () => nextStep(1));
        document.getElementById('btnStep2').addEventListener('click', () => nextStep(2));
        document.getElementById('btnPrev2').addEventListener('click', () => prevStep(2));
        document.getElementById('btnStep3').addEventListener('click', () => nextStep(3));
        document.getElementById('btnPrev3').addEventListener('click', () => prevStep(3));
        document.getElementById('btnPrev4').addEventListener('click', () => prevStep(4));
        document.getElementById('submitBtn').addEventListener('click', submitData);

        console.log("Firebase initialized and Event Listeners attached.");
    </script>
</body>
</html>
